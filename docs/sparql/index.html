<html>
  <head>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css" />

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sparql/sparql.min.js"></script>

    <style type="text/css">
      body {
        margin: 0;
        padding: 10px;
        font-family: Arial, sans-serif;
      }
      .container {
        display: flex;
        gap: 10px;
      }
      .main-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .right-panel {
        width: 350px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .col {
        width: 50%;
        border: solid 1px;
        vertical-align: top;
      }
      textarea {
        box-sizing: border-box;
        font-family: monospace;
        font-size: 14px;
        border: solid 1px;
        width: 100%;
      }
      .CodeMirror {
        height: auto;
        min-height: 200px;
        border: solid 1px #ddd;
        font-size: 14px;
        resize: vertical;
        overflow: auto;
      }
      #code-container {
        margin-bottom: 10px;
        resize: vertical;
        overflow: hidden;
        min-height: 200px;
        height: 300px;
      }
      #code-container .CodeMirror {
        height: 100%;
      }
      .result {
        width: 100%;
      }
      .dataframe {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: white;
        margin-top: 10px;
      }
      .dataframe thead th {
        background: linear-gradient(to bottom, #4a90e2 0%, #357abd 100%);
        color: white;
        text-align: center;
        padding: 12px 8px;
        font-weight: 600;
        border: 1px solid #2e6da4;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .dataframe tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background-color 0.2s ease;
      }
      .dataframe tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      .dataframe tbody tr:hover {
        background-color: #e3f2fd;
        cursor: pointer;
      }
      .dataframe tbody td {
        padding: 10px 8px;
        border: 1px solid #e0e0e0;
        vertical-align: top;
        line-height: 1.5;
      }
      .dataframe tbody td:first-child {
        font-weight: 500;
        background-color: #f5f5f5;
      }
      .dataframe tbody tr:nth-child(even) td:first-child {
        background-color: #ebebeb;
      }
      .dataframe tbody tr:hover td:first-child {
        background-color: #d1e7fd;
      }
      #sample-queries {
        border: solid 2px;
        padding: 10px;
        overflow-y: auto;
        max-height: 300px;
      }
      #sample-queries h2 {
        margin-top: 0;
      }
      #sample-queries ul {
        list-style-type: none;
        padding-left: 0;
      }
      #sample-queries li {
        margin-bottom: 8px;
      }
      #sample-queries a {
        cursor: pointer;
        color: blue;
        text-decoration: underline;
      }
      #initns {
        border: solid 2px;
        padding: 10px;
        overflow-y: auto;
        max-height: 400px;
      }
      #initns p {
        margin-top: 0;
      }
      #initns table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
      }
      #initns td {
        padding: 4px;
        word-break: break-all;
      }
      #loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .loading-text {
        margin-top: 20px;
        font-size: 18px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <div id="loading-indicator">
      <div class="spinner"></div>
      <div class="loading-text">Loading PyScript and datasets...</div>
    </div>
    <h1>Client-side sparql endpoint. Query the security knowledge graph.</h1>

    <div class="container">
      <div class="main-panel">
        <div id="code-container">
          <textarea id="code" style="display: none;">
SELECT
  ?activity
  ?iso_control_id
  ?iso_control

WHERE {
?a a dm:Activity;
   rdfs:label ?activity;
   dm:hasReference ?r
.
?r a iso:Control;
   dct:description ?iso_control;
   dct:identifier ?iso_control_id
.
} LIMIT 5
</textarea>
        </div>
        <button id="apply" style="color: white; background-color: blue; width: 100%">Query.</button>
        <div>
          <pre class="result" id="query-result" style="border-color: blue">
            Results.
          </pre>
        </div>
      </div>

      <div class="right-panel">
        <div id="sample-queries">
          <h2>Sample queries</h2>
          <ul>
            <li><a id="query1">Query 1</a></li>
            <li><a id="query2">Query 2</a></li>
            <li><a id="query3">Query 3</a></li>
            <li><a id="query4">Query 4</a></li>
            <li><a id="query5">Query 5</a></li>
            <li><a id="query6">Query 6</a></li>
          </ul>
        </div>
        <div id="initns">
          <p>
            Default namespaces are:
          </p>
        </div>
      </div>
    </div>

<!--          "./d3fend.ttl": "./d3fend.ttl", -->
<script type="text/javascript">
// Initialize CodeMirror
let editor;
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('code');
  const container = document.getElementById('code-container');

  editor = CodeMirror.fromTextArea(textarea, {
    mode: 'application/sparql-query',
    theme: 'monokai',
    lineNumbers: true,
    lineWrapping: true,
    indentWithTabs: false,
    indentUnit: 2,
    tabSize: 2,
    autofocus: true
  });

  // Refresh editor when container is resized
  const resizeObserver = new ResizeObserver(entries => {
    for (let entry of entries) {
      editor.refresh();
    }
  });
  resizeObserver.observe(container);

  // Make editor globally accessible for PyScript
  window.editor = editor;
});
</script>

<script type="py" config='{
        "packages": ["rdflib", "pandas"],
        "files": {
          "./dsomm.ttl": "./dsomm.ttl",
          "./iso27001-data.ttl": "./iso27001-data.ttl",
          "./samm.ttl": "./samm.ttl",
          "./sparql.py": "./sparql.py"
        }
      }'>
import logging
log = logging.getLogger()
from pyscript import display
from pyodide.ffi import create_proxy
from pyscript import document
from rdflib import Graph
import sparql
import pandas as pd

# Helper function to access elements
def Element(id):
    return document.querySelector(f"#{id}")

# Configure pandas to display all rows
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', None)
pd.set_option('display.width', None)
pd.set_option('display.max_colwidth', None)


graph = Graph()
for dataset_ttl in (
  "dsomm.ttl",
  "iso27001-data.ttl",
  "samm.ttl",
  # "d3fend.ttl",
):
  log.info(f"Loading {dataset_ttl}")
  graph.parse(f"./{dataset_ttl}", format="turtle")
  log.info(f"Dataset {dataset_ttl} loaded")


def on_apply(event):
  global graph
  # Get value from CodeMirror editor
  from js import window
  text = window.editor.getValue()
  ret = sparql.query(graph, text, sparql.INITNS)
  # Clear the target element before displaying new content
  result_element = Element("query-result")
  result_element.innerHTML = ""
  display(ret, target="query-result")


def create_f(query):
  def set_query(event):
    from js import window
    import textwrap
    # Remove leading whitespace from each line
    cleaned_query = textwrap.dedent(query).strip()
    window.editor.setValue(cleaned_query)
  return set_query


code = Element("code")
button = document.querySelector("button")
button.addEventListener("click", create_proxy(on_apply))


def initns_table():
  initns_table = document.createElement("table")
  initns = document.querySelector("#initns")
  for ns, url in sparql.INITNS.items():
    row = document.createElement("tr")
    cell_ns = document.createElement("td")
    cell_ns.textContent = ns
    cell_url = document.createElement("td")
    cell_url.textContent = url
    row.appendChild(cell_ns)
    row.appendChild(cell_url)
    initns_table.appendChild(row)
  initns.append(initns_table)


if True:
  initns_table()

  for button_id, query in sparql.QUERIES.items():
    log.info("button_id" + button_id)
    b = document.querySelector(f'#{button_id}')
    if not b:
      log.info("button not found")
      continue
    # log.warning("Button %r", dir(b))
    b.innerHTML = query["label"]
    b.addEventListener("click", create_proxy(create_f(query["query"])))

  # Hide loading indicator after everything is loaded
  loading_indicator = document.querySelector("#loading-indicator")
  if loading_indicator:
    loading_indicator.style.display = "none"

</script>
    </body>
</html>
